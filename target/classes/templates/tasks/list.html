<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">
<head>
    <title>Tasks - FRC Project Management</title>
</head>

<div layout:fragment="styles">
    <style>
        /* Enhanced Task List Styles - Phase 2E-B Real-time Integration */
        .task-header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 2rem 0;
            position: relative;
            overflow: hidden;
        }
        
        .task-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.3;
        }
        
        .task-item {
            transition: all 0.3s ease;
            border-radius: 12px;
            margin-bottom: 16px;
            border-left: 5px solid transparent;
            position: relative;
            overflow: hidden;
        }
        
        .task-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }
        
        .task-item.priority-critical {
            border-left-color: #dc3545;
            background: linear-gradient(135deg, #fff 0%, #fff5f5 100%);
        }
        
        .task-item.priority-high {
            border-left-color: #fd7e14;
            background: linear-gradient(135deg, #fff 0%, #fff8f0 100%);
        }
        
        .task-item.priority-medium {
            border-left-color: #ffc107;
            background: linear-gradient(135deg, #fff 0%, #fffcf0 100%);
        }
        
        .task-item.priority-low {
            border-left-color: #6c757d;
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
        }
        
        .task-item.completed {
            opacity: 0.85;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        .task-item.updated {
            border-left-color: #0066cc !important;
            background: linear-gradient(135deg, #e7f3ff 0%, #cce7ff 100%);
            animation: taskHighlight 3s ease-out;
        }
        
        .task-item.real-time-update {
            position: relative;
        }
        
        .task-item.real-time-update::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-top: 20px solid #28a745;
            opacity: 0;
            animation: realtimeIndicator 2s ease-in-out;
        }
        
        @keyframes taskHighlight {
            0% { 
                background: linear-gradient(135deg, #cce7ff 0%, #99d7ff 100%);
                transform: scale(1.02);
            }
            100% { 
                background: inherit;
                transform: scale(1);
            }
        }
        
        @keyframes realtimeIndicator {
            0% { opacity: 0; transform: scale(0); }
            50% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0); }
        }
        
        .progress-bar {
            transition: width 0.8s ease-in-out;
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar.updating::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: progressShimmer 1.5s ease-in-out;
        }
        
        @keyframes progressShimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .real-time-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: #28a745;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
            box-shadow: 0 0 8px rgba(40, 167, 69, 0.6);
        }
        
        .real-time-indicator.disconnected {
            background-color: #dc3545;
            animation: none;
            box-shadow: 0 0 8px rgba(220, 53, 69, 0.6);
        }
        
        .real-time-indicator.connecting {
            background-color: #ffc107;
            animation: pulse 1s infinite;
            box-shadow: 0 0 8px rgba(255, 193, 7, 0.6);
        }
        
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .filter-badge {
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 20px;
            border: 2px solid transparent;
        }
        
        .filter-badge:hover {
            transform: scale(1.05);
            border-color: rgba(0, 102, 204, 0.3);
        }
        
        .filter-badge.active {
            background-color: #0066cc !important;
            color: white !important;
            border-color: #0066cc;
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.3);
        }
        
        .task-assignees {
            max-width: 180px;
        }
        
        .task-assignee-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, #0066cc 0%, #004499 100%);
            color: white;
            font-size: 11px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 6px;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        
        .task-assignee-avatar:hover {
            transform: scale(1.1);
            z-index: 10;
        }
        
        .quick-action-btn {
            border: none;
            background: none;
            color: #6c757d;
            font-size: 18px;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .quick-action-btn:hover {
            background-color: #f8f9fa;
            color: #0066cc;
            transform: scale(1.1);
        }
        
        .quick-action-btn.loading {
            pointer-events: none;
        }
        
        .quick-action-btn.loading::after {
            content: '';
            position: absolute;
            width: 14px;
            height: 14px;
            border: 2px solid #ccc;
            border-radius: 50%;
            border-top: 2px solid #0066cc;
            animation: spin 1s linear infinite;
            top: 50%;
            left: 50%;
            margin: -7px 0 0 -7px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .bulk-actions {
            position: sticky;
            top: 0;
            z-index: 100;
            background: white;
            border-bottom: 1px solid #dee2e6;
            padding: 1rem 0;
            margin: -1rem 0 1rem 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .bulk-actions.hidden {
            display: none;
        }
        
        .activity-feed {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 12px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
        }
        
        .activity-item {
            transition: all 0.3s ease;
            border-radius: 8px;
            margin-bottom: 8px;
            padding: 12px;
            border-left: 3px solid transparent;
        }
        
        .activity-item:hover {
            background-color: rgba(0, 102, 204, 0.05);
            border-left-color: #0066cc;
        }
        
        .activity-item.highlight {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border-left-color: #ffc107;
            animation: activityHighlight 2s ease-out;
        }
        
        @keyframes activityHighlight {
            0% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }
        
        .connection-status-banner {
            position: fixed;
            top: 76px;
            left: 0;
            right: 0;
            z-index: 1050;
            padding: 0.5rem;
            text-align: center;
            font-weight: 500;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }
        
        .connection-status-banner.show {
            transform: translateY(0);
        }
        
        .view-toggle {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .real-time-stats {
            background: linear-gradient(135deg, #0066cc 0%, #004499 100%);
            color: white;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .stats-item {
            text-align: center;
        }
        
        .stats-value {
            font-size: 1.5rem;
            font-weight: 600;
            display: block;
        }
        
        .stats-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }
        
        /* Enhanced modals */
        .modal-content {
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .progress-modal .progress {
            height: 25px;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .progress-modal .progress-bar {
            background: linear-gradient(45deg, #28a745, #20c997);
            transition: width 0.5s ease;
        }
        
        /* Mobile enhancements */
        @media (max-width: 768px) {
            .task-item {
                margin-bottom: 12px;
                padding: 1rem !important;
            }
            
            .quick-action-btn {
                font-size: 20px;
                padding: 10px;
            }
            
            .task-assignee-avatar {
                width: 32px;
                height: 32px;
                font-size: 12px;
            }
        }
    </style>
</div>

<body>
<div layout:fragment="content">
    <!-- Enhanced Task Management Header -->
    <div class="task-header">
        <div class="container" style="position: relative; z-index: 1;">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-1">
                        <i class="fas fa-tasks me-3"></i>Task Management
                        <span class="badge bg-light text-dark ms-2" id="version-badge">Phase 2E-B</span>
                    </h1>
                    <p class="mb-0 opacity-75">
                        Real-time task coordination for your FRC project
                        <span class="real-time-indicator" id="realtime-status"></span>
                        <small id="connection-text">Connecting to real-time updates...</small>
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <a href="/tasks/new" class="btn btn-light me-2">
                        <i class="fas fa-plus me-2"></i>New Task
                    </a>
                    <a href="/dashboard" class="btn btn-outline-light">
                        <i class="fas fa-arrow-left me-2"></i>Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Connection Status Banner -->
    <div id="connection-banner" class="connection-status-banner alert alert-warning mb-0">
        <span id="connection-banner-text">Establishing real-time connection...</span>
    </div>

    <div class="container my-4">
        <!-- Real-time Statistics Dashboard -->
        <div class="real-time-stats">
            <div class="row">
                <div class="col-md-3">
                    <div class="stats-item">
                        <span class="stats-value" id="stats-total">0</span>
                        <span class="stats-label">Total Tasks</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-item">
                        <span class="stats-value" id="stats-pending">0</span>
                        <span class="stats-label">In Progress</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-item">
                        <span class="stats-value" id="stats-completed">0</span>
                        <span class="stats-label">Completed</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-item">
                        <span class="stats-value" id="stats-active-users">0</span>
                        <span class="stats-label">Active Users</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Filters and Quick Stats -->
        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h5 class="mb-3">
                                    <i class="fas fa-filter me-2"></i>Filter Tasks
                                    <span class="badge bg-success ms-2" id="live-count">Live Updates: ON</span>
                                </h5>
                                <div class="d-flex flex-wrap gap-2">
                                    <span class="badge bg-secondary filter-badge" 
                                          data-filter="all" 
                                          th:classappend="${currentStatus == 'all'} ? 'active' : ''">
                                        All (<span th:text="${totalTasks}" id="count-all">0</span>)
                                    </span>
                                    <span class="badge bg-warning filter-badge" 
                                          data-filter="pending"
                                          th:classappend="${currentStatus == 'pending'} ? 'active' : ''">
                                        Pending (<span th:text="${pendingCount}" id="count-pending">0</span>)
                                    </span>
                                    <span class="badge bg-success filter-badge" 
                                          data-filter="completed"
                                          th:classappend="${currentStatus == 'completed'} ? 'active' : ''">
                                        Completed (<span th:text="${completedCount}" id="count-completed">0</span>)
                                    </span>
                                    <span class="badge bg-danger filter-badge" 
                                          data-filter="overdue"
                                          th:classappend="${currentStatus == 'overdue'} ? 'active' : ''">
                                        Overdue (<span th:text="${overdueCount}" id="count-overdue">0</span>)
                                    </span>
                                    <span class="badge bg-info filter-badge" 
                                          data-filter="due-soon"
                                          th:classappend="${currentStatus == 'due-soon'} ? 'active' : ''">
                                        Due Soon (<span th:text="${dueSoonCount}" id="count-due-soon">0</span>)
                                    </span>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="btn-group view-toggle" role="group">
                                    <input type="radio" class="btn-check" name="viewToggle" id="listView" checked>
                                    <label class="btn btn-outline-primary" for="listView">
                                        <i class="fas fa-list me-2"></i>List
                                    </label>
                                    <input type="radio" class="btn-check" name="viewToggle" id="kanbanView">
                                    <label class="btn btn-outline-primary" for="kanbanView">
                                        <i class="fas fa-columns me-2"></i>Kanban
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Advanced Filters -->
                        <div class="row mt-3">
                            <div class="col-md-3">
                                <select class="form-select form-select-sm" id="projectFilter">
                                    <option value="">All Projects</option>
                                    <option th:each="project : ${projectOptions}" 
                                            th:value="${project.id}" 
                                            th:text="${project.name}"
                                            th:selected="${currentProjectId == project.id}">
                                    </option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select form-select-sm" id="subsystemFilter">
                                    <option value="">All Subsystems</option>
                                    <option th:each="subsystem : ${subsystemOptions}" 
                                            th:value="${subsystem.id}" 
                                            th:text="${subsystem.name}"
                                            th:selected="${currentSubsystemId == subsystem.id}">
                                    </option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select form-select-sm" id="priorityFilter">
                                    <option value="">All Priorities</option>
                                    <option th:each="priority : ${priorityOptions}" 
                                            th:value="${priority.name()}" 
                                            th:text="${priority.displayName}"
                                            th:selected="${currentPriority == priority.name()}">
                                    </option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <input type="text" class="form-control form-control-sm" 
                                       id="searchInput" placeholder="Search tasks..." autocomplete="off">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Real-time Activity Feed -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-stream me-2"></i>Live Activity
                        </h6>
                        <span class="badge bg-success" id="activity-indicator">
                            <span class="real-time-indicator"></span>Live
                        </span>
                    </div>
                    <div class="card-body p-2">
                        <div id="activity-feed" class="activity-feed">
                            <div class="text-center py-4 text-muted">
                                <i class="fas fa-clock fa-2x mb-2"></i>
                                <div>Waiting for team activity...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bulk Actions Bar -->
        <div id="bulk-actions" class="bulk-actions hidden">
            <div class="card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <span class="fw-semibold">
                                <span id="selected-count">0</span> tasks selected
                            </span>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-success btn-sm" id="bulk-complete">
                                    <i class="fas fa-check me-1"></i>Mark Complete
                                </button>
                                <button type="button" class="btn btn-outline-warning btn-sm" id="bulk-assign">
                                    <i class="fas fa-user-plus me-1"></i>Assign
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-sm" id="bulk-priority">
                                    <i class="fas fa-exclamation me-1"></i>Set Priority
                                </button>
                                <button type="button" class="btn btn-outline-danger btn-sm" id="bulk-delete">
                                    <i class="fas fa-trash me-1"></i>Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Task List View -->
        <div id="taskListView">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-list me-2"></i>Tasks
                                <span class="badge bg-primary ms-2" id="visible-task-count">0</span>
                            </h5>
                            <div class="d-flex gap-2">
                                <select class="form-select form-select-sm" id="sortBy" style="width: auto;">
                                    <option value="priority">Sort by Priority</option>
                                    <option value="duedate">Sort by Due Date</option>
                                    <option value="progress">Sort by Progress</option>
                                    <option value="title">Sort by Title</option>
                                    <option value="project">Sort by Project</option>
                                    <option value="recent">Sort by Recent Updates</option>
                                </select>
                                <button class="btn btn-outline-secondary btn-sm" id="refresh-tasks" title="Refresh">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div id="taskList">
                                <!-- Empty state -->
                                <div th:if="${tasks.empty}" class="text-center py-5" id="empty-state">
                                    <i class="fas fa-tasks fa-3x text-muted mb-3"></i>
                                    <h4 class="text-muted">No tasks found</h4>
                                    <p class="text-muted">Create your first task to get started!</p>
                                    <a href="/tasks/new" class="btn btn-primary">
                                        <i class="fas fa-plus me-2"></i>Create Task
                                    </a>
                                </div>
                                
                                <!-- Task List Items -->
                                <div th:each="task : ${tasks}" 
                                     class="task-item p-3 border-bottom"
                                     th:classappend="'priority-' + ${task.priority.name().toLowerCase()} + ' ' + ${task.completed ? 'completed' : ''}"
                                     th:data-task-id="${task.id}"
                                     th:data-project-id="${task.project.id}"
                                     th:data-priority="${task.priority.name()}"
                                     th:data-status="${task.completed ? 'completed' : 'pending'}"
                                     th:data-title="${task.title}"
                                     th:data-progress="${task.progress}">
                                    
                                    <div class="row align-items-center">
                                        <!-- Bulk Selection Checkbox -->
                                        <div class="col-auto">
                                            <input type="checkbox" class="form-check-input task-checkbox" 
                                                   th:value="${task.id}">
                                        </div>
                                        
                                        <!-- Task Info -->
                                        <div class="col">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-1 task-title">
                                                        <a th:href="@{/tasks/{id}(id=${task.id})}" 
                                                           class="text-decoration-none" 
                                                           th:text="${task.title}">Task Title</a>
                                                        <span class="badge badge-sm ms-2 priority-badge"
                                                              th:classappend="${task.priority.name() == 'CRITICAL'} ? 'bg-danger' : 
                                                                           ${task.priority.name() == 'HIGH'} ? 'bg-warning' : 
                                                                           ${task.priority.name() == 'MEDIUM'} ? 'bg-info' : 'bg-secondary'"
                                                              th:text="${task.priority.displayName}">Priority</span>
                                                    </h6>
                                                    <div class="small text-muted mb-2 task-meta">
                                                        <span class="me-3">
                                                            <i class="fas fa-project-diagram me-1"></i>
                                                            <span th:text="${task.project.name}" class="project-name">Project</span>
                                                        </span>
                                                        <span class="me-3">
                                                            <i class="fas fa-cogs me-1"></i>
                                                            <span th:text="${task.subsystem.name}" class="subsystem-name">Subsystem</span>
                                                        </span>
                                                        <span th:if="${task.endDate}" class="me-3 due-date">
                                                            <i class="fas fa-calendar me-1"></i>
                                                            Due: <span th:text="${#temporals.format(task.endDate, 'MMM dd')}">Date</span>
                                                        </span>
                                                        <span class="last-updated text-muted" style="font-size: 0.75rem;">
                                                            Last updated: <span class="update-time">Just now</span>
                                                        </span>
                                                    </div>
                                                    
                                                    <!-- Enhanced Progress Bar -->
                                                    <div class="progress mb-2" style="height: 8px;">
                                                        <div class="progress-bar task-progress-bar" 
                                                             role="progressbar" 
                                                             th:style="'width: ' + ${task.progress} + '%'"
                                                             th:classappend="${task.completed} ? 'bg-success' : 
                                                                           ${task.progress >= 75} ? 'bg-info' : 
                                                                           ${task.progress >= 50} ? 'bg-warning' : 'bg-danger'"
                                                             th:attr="aria-valuenow=${task.progress}"
                                                             th:data-original-progress="${task.progress}">
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Enhanced Assignees -->
                                                    <div class="task-assignees" th:if="${!task.assignedTo.empty}">
                                                        <small class="text-muted me-2">Assigned to:</small>
                                                        <span th:each="member : ${task.assignedTo}" 
                                                              class="task-assignee-avatar"
                                                              th:title="${member.fullName}"
                                                              th:text="${member.firstName.substring(0,1) + member.lastName.substring(0,1)}"
                                                              th:data-member-id="${member.id}">
                                                        </span>
                                                    </div>
                                                </div>
                                                
                                                <!-- Real-time Progress Indicator -->
                                                <div class="text-center">
                                                    <div class="h4 mb-0 task-progress-text" th:text="${task.progress + '%'}">0%</div>
                                                    <small class="text-muted">Progress</small>
                                                    <div class="real-time-indicator d-none" id="task-updating-${task.id}"></div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Enhanced Quick Actions -->
                                        <div class="col-auto">
                                            <div class="btn-group" role="group">
                                                <!-- Progress Update Buttons -->
                                                <button type="button" class="quick-action-btn progress-btn" 
                                                        th:data-task-id="${task.id}"
                                                        th:data-current-progress="${task.progress}"
                                                        title="Quick progress update">
                                                    <i class="fas fa-plus-circle"></i>
                                                </button>
                                                
                                                <!-- Complete Toggle -->
                                                <button type="button" class="quick-action-btn complete-btn"
                                                        th:data-task-id="${task.id}"
                                                        th:data-completed="${task.completed}"
                                                        th:title="${task.completed ? 'Mark incomplete' : 'Mark complete'}">
                                                    <i th:class="${task.completed ? 'fas fa-undo' : 'fas fa-check'}" 
                                                       th:style="${task.completed ? 'color: #ffc107' : 'color: #28a745'}"></i>
                                                </button>
                                                
                                                <!-- Task Detail -->
                                                <a th:href="@{/tasks/{id}(id=${task.id})}" 
                                                   class="quick-action-btn" title="View details">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                
                                                <!-- Edit Task (Phase 2E-B) -->
                                                <a th:href="@{/tasks/{id}/edit(id=${task.id})}" 
                                                   class="quick-action-btn" title="Edit task">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Quick Progress Update Modal -->
        <div class="modal fade" id="progressModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content progress-modal">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-chart-line me-2"></i>Update Task Progress
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="progressSlider" class="form-label">
                                Progress: <span id="progressValue" class="fw-bold text-primary">0</span>%
                            </label>
                            <input type="range" class="form-range" min="0" max="100" step="5" 
                                   id="progressSlider" value="0">
                        </div>
                        <div class="progress mb-3">
                            <div class="progress-bar" id="progressPreview" role="progressbar" 
                                 style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                <span class="text-white fw-semibold">0%</span>
                            </div>
                        </div>
                        
                        <!-- Quick Progress Buttons -->
                        <div class="d-flex justify-content-center gap-2 mb-3">
                            <button type="button" class="btn btn-outline-secondary btn-sm quick-progress" data-progress="25">25%</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm quick-progress" data-progress="50">50%</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm quick-progress" data-progress="75">75%</button>
                            <button type="button" class="btn btn-outline-success btn-sm quick-progress" data-progress="100">Complete</button>
                        </div>
                        
                        <div id="progressFeedback" class="alert" style="display: none;"></div>
                        
                        <!-- Real-time Update Status -->
                        <div id="realtime-update-status" class="text-center text-muted small">
                            <span class="real-time-indicator"></span>
                            Changes will sync instantly across all devices
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="saveProgress">
                            <i class="fas fa-save me-2"></i>Update Progress
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div layout:fragment="scripts">
    <script>
        // ================================================================
        // PHASE 2E-B: REAL-TIME TASK MANAGEMENT SYSTEM
        // Full WebSocket Integration with Enhanced UI
        // ================================================================
        
        // Global state management
        let stompClient = null;
        let isConnected = false;
        let currentTaskId = null;
        let selectedTasks = new Set();
        let currentProjectId = null;
        let taskUpdateQueue = new Map();
        let activityBuffer = [];
        
        // Configuration
        const config = {
            reconnectDelay: 3000,
            maxReconnectAttempts: 10,
            heartbeatInterval: 25000,
            updateBatchSize: 10,
            activityBufferSize: 50
        };
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸš€ Phase 2E-B Task List: Initializing real-time features...');
            
            initializeTaskList();
            connectToRealTimeWebSocket();
            setupEnhancedEventHandlers();
            setupBulkOperations();
            setupAdvancedFiltering();
            updateStatistics();
            
            console.log('âœ… Phase 2E-B Task List: All systems operational');
        });
        
        // ================================================================
        // REAL-TIME WEBSOCKET CONNECTION
        // ================================================================
        
        function connectToRealTimeWebSocket() {
            const statusIndicator = document.getElementById('realtime-status');
            const connectionText = document.getElementById('connection-text');
            const connectionBanner = document.getElementById('connection-banner');
            const bannerText = document.getElementById('connection-banner-text');
            
            updateConnectionStatus('connecting', 'Establishing real-time connection...');
            showConnectionBanner('Connecting to real-time updates...', 'warning');
            
            try {
                const socket = new SockJS('/ws');
                stompClient = new StompJs.Client({
                    webSocketFactory: () => socket,
                    reconnectDelay: config.reconnectDelay,
                    heartbeatIncoming: config.heartbeatInterval,
                    heartbeatOutgoing: config.heartbeatInterval,
                    maxReconnectionDelay: 10000
                });
                
                stompClient.onConnect = function(frame) {
                    console.log('âœ… Connected to real-time task updates:', frame);
                    isConnected = true;
                    updateConnectionStatus('connected', 'Real-time updates active');
                    showConnectionBanner('Real-time updates connected!', 'success', 3000);
                    
                    // Subscribe to all real-time channels
                    subscribeToTaskUpdates();
                    subscribeToActivityFeed();
                    subscribeToProjectNotifications();
                    
                    // Send presence update
                    sendPresenceUpdate('ONLINE');
                    
                    // Process any queued updates
                    processQueuedUpdates();
                };
                
                stompClient.onStompError = function(frame) {
                    console.error('âŒ Real-time connection error:', frame);
                    isConnected = false;
                    updateConnectionStatus('disconnected', 'Connection error - retrying...');
                    showConnectionBanner('Real-time connection failed - attempting to reconnect...', 'danger');
                };
                
                stompClient.onWebSocketClose = function(event) {
                    console.log('ðŸ”Œ Real-time connection closed');
                    isConnected = false;
                    updateConnectionStatus('disconnected', 'Offline mode - will reconnect automatically');
                    showConnectionBanner('Working offline - changes will sync when reconnected', 'warning');
                };
                
                stompClient.onWebSocketError = function(event) {
                    console.error('ðŸ”¥ WebSocket error:', event);
                    updateConnectionStatus('disconnected', 'Connection error');
                };
                
                stompClient.activate();
                
            } catch (error) {
                console.error('ðŸ’¥ Failed to initialize WebSocket:', error);
                updateConnectionStatus('disconnected', 'Real-time features unavailable');
                showConnectionBanner('Real-time features unavailable - working in offline mode', 'danger', 0);
            }
        }
        
        // ================================================================
        // WEBSOCKET SUBSCRIPTIONS
        // ================================================================
        
        function subscribeToTaskUpdates() {
            // Subscribe to all task updates
            stompClient.subscribe('/topic/tasks/updates', function(message) {
                const taskUpdate = JSON.parse(message.body);
                handleRealTimeTaskUpdate(taskUpdate);
            });
            
            // Subscribe to project-specific updates if we have a current project
            if (currentProjectId) {
                stompClient.subscribe(`/topic/project/${currentProjectId}`, function(message) {
                    const taskUpdate = JSON.parse(message.body);
                    handleRealTimeTaskUpdate(taskUpdate);
                });
            }
            
            console.log('ðŸ“¡ Subscribed to task updates');
        }
        
        function subscribeToActivityFeed() {
            // Subscribe to team activity feed
            stompClient.subscribe('/topic/team/activity', function(message) {
                const activity = JSON.parse(message.body);
                addToActivityFeed(activity);
            });
            
            // Subscribe to project activity if we have a current project
            if (currentProjectId) {
                stompClient.subscribe(`/topic/project/${currentProjectId}/activity`, function(message) {
                    const activity = JSON.parse(message.body);
                    addToActivityFeed(activity);
                });
            }
            
            console.log('ðŸ“¡ Subscribed to activity feed');
        }
        
        function subscribeToProjectNotifications() {
            // Subscribe to project notifications
            if (currentProjectId) {
                stompClient.subscribe(`/topic/project/${currentProjectId}/notifications`, function(message) {
                    const notification = JSON.parse(message.body);
                    showRealTimeNotification(notification);
                });
            }
            
            // Subscribe to system-wide alerts
            stompClient.subscribe('/topic/system/alerts', function(message) {
                const alert = JSON.parse(message.body);
                showRealTimeNotification(alert);
            });
            
            console.log('ðŸ“¡ Subscribed to notifications');
        }
        
        // ================================================================
        // REAL-TIME UPDATE HANDLERS
        // ================================================================
        
        function handleRealTimeTaskUpdate(taskUpdate) {
            console.log('ðŸ“¨ Real-time task update received:', taskUpdate);
            
            try {
                // Find the task element
                const taskElement = document.querySelector(`[data-task-id="${taskUpdate.taskId}"]`);
                
                if (taskElement) {
                    // Show real-time update indicator
                    showTaskUpdateIndicator(taskUpdate.taskId);
                    
                    // Update progress if changed
                    if (taskUpdate.progress !== null) {
                        updateTaskProgressInList(taskUpdate.taskId, taskUpdate.progress);
                    }
                    
                    // Update completion status
                    if (taskUpdate.changeType === 'COMPLETED') {
                        markTaskAsCompleted(taskUpdate.taskId);
                    }
                    
                    // Update task metadata
                    updateTaskMetadata(taskUpdate.taskId, taskUpdate);
                    
                    // Add visual highlight for the update
                    highlightTaskUpdate(taskUpdate.taskId);
                    
                    // Update statistics
                    updateStatistics();
                    
                    // Add to activity feed if not from current user
                    if (taskUpdate.updatedBy !== getCurrentUsername()) {
                        addTaskUpdateToActivity(taskUpdate);
                    }
                    
                } else if (taskUpdate.changeType === 'CREATED') {
                    // Handle new task creation
                    handleNewTaskCreation(taskUpdate);
                }
                
                // Update filter counts
                updateFilterCounts();
                
            } catch (error) {
                console.error('âŒ Error handling real-time task update:', error);
            }
        }
        
        function updateTaskProgressInList(taskId, newProgress) {
            const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
            if (!taskElement) return;
            
            const progressBar = taskElement.querySelector('.task-progress-bar');
            const progressText = taskElement.querySelector('.task-progress-text');
            
            if (progressBar) {
                // Add shimmer effect
                progressBar.classList.add('updating');
                
                // Update progress with animation
                setTimeout(() => {
                    progressBar.style.width = newProgress + '%';
                    progressBar.setAttribute('aria-valuenow', newProgress);
                    progressBar.className = 'progress-bar task-progress-bar ' + getProgressBarClass(newProgress);
                    
                    // Remove shimmer effect
                    setTimeout(() => {
                        progressBar.classList.remove('updating');
                    }, 1000);
                }, 100);
            }
            
            if (progressText) {
                progressText.textContent = newProgress + '%';
            }
            
            // Update data attributes
            taskElement.dataset.progress = newProgress;
            
            // Update completion status
            if (newProgress >= 100) {
                taskElement.classList.add('completed');
                taskElement.dataset.status = 'completed';
            } else {
                taskElement.classList.remove('completed');
                taskElement.dataset.status = 'pending';
            }
            
            // Update last modified time
            updateTaskTimestamp(taskId);
        }
        
        function showTaskUpdateIndicator(taskId) {
            const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
            if (taskElement) {
                taskElement.classList.add('real-time-update');
                
                // Remove the indicator after animation
                setTimeout(() => {
                    taskElement.classList.remove('real-time-update');
                }, 2000);
            }
        }
        
        function highlightTaskUpdate(taskId) {
            const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
            if (taskElement) {
                taskElement.classList.add('updated');
                
                // Scroll into view if not visible
                if (!isElementInViewport(taskElement)) {
                    taskElement.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center',
                        inline: 'nearest'
                    });
                }
                
                // Remove highlight after animation
                setTimeout(() => {
                    taskElement.classList.remove('updated');
                }, 3000);
            }
        }
        
        function updateTaskTimestamp(taskId) {
            const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
            if (taskElement) {
                const timestampElement = taskElement.querySelector('.update-time');
                if (timestampElement) {
                    timestampElement.textContent = 'Just now';
                    
                    // Gradually update to relative time
                    setTimeout(() => {
                        timestampElement.textContent = 'A moment ago';
                    }, 5000);
                }
            }
        }
        
        // ================================================================
        // ACTIVITY FEED MANAGEMENT
        // ================================================================
        
        function addToActivityFeed(activity) {
            const activityFeed = document.getElementById('activity-feed');
            if (!activityFeed) return;
            
            // Remove placeholder if present
            const placeholder = activityFeed.querySelector('.text-center');
            if (placeholder && placeholder.textContent.includes('Waiting')) {
                placeholder.remove();
            }
            
            // Create activity item
            const activityItem = createActivityItem(activity);
            
            // Add to top of feed
            activityFeed.insertBefore(activityItem, activityFeed.firstChild);
            
            // Animate entry
            setTimeout(() => {
                activityItem.classList.add('highlight');
                setTimeout(() => {
                    activityItem.classList.remove('highlight');
                }, 2000);
            }, 100);
            
            // Keep only last 20 items
            while (activityFeed.children.length > 20) {
                activityFeed.removeChild(activityFeed.lastChild);
            }
            
            // Update active users count
            updateActiveUsersCount();
        }
        
        function createActivityItem(activity) {
            const activityItem = document.createElement('div');
            activityItem.className = 'activity-item';
            
            const timeAgo = getTimeAgo(activity.timestamp);
            const iconClass = activity.iconClass || 'fas fa-user';
            const severityClass = getSeverityClass(activity.severity);
            
            activityItem.innerHTML = `
                <div class="d-flex align-items-start">
                    <div class="flex-shrink-0 me-2">
                        <i class="${iconClass} ${severityClass}"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="small">
                            <strong>${activity.userName}</strong>
                            ${activity.description}
                        </div>
                        <div class="text-muted" style="font-size: 0.75rem;">
                            ${timeAgo}
                            ${activity.subteamName ? ` â€¢ ${activity.subteamName}` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            return activityItem;
        }
        
        function addTaskUpdateToActivity(taskUpdate) {
            const activity = {
                userId: null,
                userName: taskUpdate.updatedBy,
                action: taskUpdate.changeType,
                description: generateActivityDescription(taskUpdate),
                timestamp: taskUpdate.timestamp || new Date().toISOString(),
                iconClass: getTaskUpdateIcon(taskUpdate.changeType),
                severity: taskUpdate.changeType === 'COMPLETED' ? 'SUCCESS' : 'INFO'
            };
            
            addToActivityFeed(activity);
        }
        
        function generateActivityDescription(taskUpdate) {
            switch (taskUpdate.changeType) {
                case 'PROGRESS_CHANGED':
                    return `updated "${taskUpdate.taskTitle}" to ${taskUpdate.progress}%`;
                case 'COMPLETED':
                    return `completed "${taskUpdate.taskTitle}"`;
                case 'CREATED':
                    return `created new task "${taskUpdate.taskTitle}"`;
                case 'UPDATED':
                    return `modified "${taskUpdate.taskTitle}"`;
                default:
                    return `updated "${taskUpdate.taskTitle}"`;
            }
        }
        
        // ================================================================
        // ENHANCED EVENT HANDLERS
        // ================================================================
        
        function setupEnhancedEventHandlers() {
            // Task list event delegation
            document.addEventListener('click', function(e) {
                // Progress button clicks
                if (e.target.closest('.progress-btn')) {
                    const btn = e.target.closest('.progress-btn');
                    const taskId = btn.dataset.taskId;
                    const currentProgress = parseInt(btn.dataset.currentProgress);
                    showEnhancedProgressModal(taskId, currentProgress);
                }
                
                // Complete button clicks
                if (e.target.closest('.complete-btn')) {
                    const btn = e.target.closest('.complete-btn');
                    const taskId = btn.dataset.taskId;
                    const isCompleted = btn.dataset.completed === 'true';
                    toggleTaskCompletionWithRealTime(taskId, !isCompleted);
                }
                
                // Task checkbox clicks
                if (e.target.classList.contains('task-checkbox')) {
                    handleTaskSelection(e.target);
                }
                
                // Quick progress buttons in modal
                if (e.target.classList.contains('quick-progress')) {
                    const progress = parseInt(e.target.dataset.progress);
                    setModalProgress(progress);
                }
            });
            
            // Enhanced filtering
            setupEnhancedFiltering();
            
            // Enhanced progress modal
            setupEnhancedProgressModal();
            
            // Real-time search
            setupRealTimeSearch();
        }
        
        function setupEnhancedProgressModal() {
            const progressSlider = document.getElementById('progressSlider');
            const progressValue = document.getElementById('progressValue');
            const progressPreview = document.getElementById('progressPreview');
            const saveButton = document.getElementById('saveProgress');
            
            if (progressSlider) {
                progressSlider.addEventListener('input', function() {
                    const value = parseInt(this.value);
                    updateModalProgress(value);
                });
            }
            
            if (saveButton) {
                saveButton.addEventListener('click', function() {
                    if (currentTaskId) {
                        const progress = parseInt(progressSlider.value);
                        saveTaskProgressWithRealTime(currentTaskId, progress);
                    }
                });
            }
        }
        
        function showEnhancedProgressModal(taskId, currentProgress) {
            currentTaskId = taskId;
            const modal = document.getElementById('progressModal');
            const progressSlider = document.getElementById('progressSlider');
            
            // Set current values
            progressSlider.value = currentProgress;
            updateModalProgress(currentProgress);
            
            // Show modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            // Focus on slider for keyboard navigation
            setTimeout(() => {
                progressSlider.focus();
            }, 300);
        }
        
        function updateModalProgress(value) {
            const progressValue = document.getElementById('progressValue');
            const progressPreview = document.getElementById('progressPreview');
            
            if (progressValue) {
                progressValue.textContent = value;
            }
            
            if (progressPreview) {
                progressPreview.style.width = value + '%';
                progressPreview.setAttribute('aria-valuenow', value);
                progressPreview.className = 'progress-bar ' + getProgressBarClass(value);
                progressPreview.querySelector('span').textContent = value + '%';
            }
        }
        
        function setModalProgress(value) {
            const progressSlider = document.getElementById('progressSlider');
            if (progressSlider) {
                progressSlider.value = value;
                updateModalProgress(value);
            }
        }
        
        // ================================================================
        // REAL-TIME TASK OPERATIONS
        // ================================================================
        
        function saveTaskProgressWithRealTime(taskId, progress) {
            const saveButton = document.getElementById('saveProgress');
            if (saveButton) {
                saveButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';
                saveButton.disabled = true;
            }
            
            // Show real-time indicator
            showTaskUpdateIndicator(taskId);
            
            fetch(`/tasks/${taskId}/progress`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: `progress=${progress}`
            })
            .then(response => {
                if (response.ok) {
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('progressModal'));
                    modal.hide();
                    
                    // The real-time update will be received via WebSocket
                    // So we don't need to update the UI here
                    
                    showToast('Success', 'Task progress updated successfully!', 'success');
                } else {
                    throw new Error('Failed to update progress');
                }
            })
            .catch(error => {
                console.error('âŒ Error updating progress:', error);
                showToast('Error', 'Failed to update task progress. Please try again.', 'error');
            })
            .finally(() => {
                if (saveButton) {
                    saveButton.innerHTML = '<i class="fas fa-save me-2"></i>Update Progress';
                    saveButton.disabled = false;
                }
            });
        }
        
        function toggleTaskCompletionWithRealTime(taskId, completed) {
            const progress = completed ? 100 : 0;
            const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
            const btn = taskElement?.querySelector('.complete-btn');
            
            if (btn) {
                btn.classList.add('loading');
            }
            
            // Show real-time indicator
            showTaskUpdateIndicator(taskId);
            
            fetch(`/tasks/${taskId}/progress`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: `progress=${progress}`
            })
            .then(response => {
                if (response.ok) {
                    // The real-time update will be received via WebSocket
                    const action = completed ? 'completed' : 'reopened';
                    showToast('Success', `Task ${action} successfully!`, 'success');
                } else {
                    throw new Error('Failed to update task');
                }
            })
            .catch(error => {
                console.error('âŒ Error updating task:', error);
                showToast('Error', 'Failed to update task. Please try again.', 'error');
            })
            .finally(() => {
                if (btn) {
                    btn.classList.remove('loading');
                }
            });
        }
        
        // ================================================================
        // BULK OPERATIONS
        // ================================================================
        
        function setupBulkOperations() {
            const bulkActions = document.getElementById('bulk-actions');
            const selectedCountSpan = document.getElementById('selected-count');
            
            // Bulk action handlers
            document.getElementById('bulk-complete')?.addEventListener('click', () => {
                if (selectedTasks.size > 0) {
                    bulkUpdateProgress(Array.from(selectedTasks), 100);
                }
            });
            
            document.getElementById('bulk-assign')?.addEventListener('click', () => {
                if (selectedTasks.size > 0) {
                    showBulkAssignModal(Array.from(selectedTasks));
                }
            });
            
            document.getElementById('bulk-priority')?.addEventListener('click', () => {
                if (selectedTasks.size > 0) {
                    showBulkPriorityModal(Array.from(selectedTasks));
                }
            });
            
            document.getElementById('bulk-delete')?.addEventListener('click', () => {
                if (selectedTasks.size > 0) {
                    confirmBulkDelete(Array.from(selectedTasks));
                }
            });
        }
        
        function handleTaskSelection(checkbox) {
            const taskId = checkbox.value;
            
            if (checkbox.checked) {
                selectedTasks.add(taskId);
            } else {
                selectedTasks.delete(taskId);
            }
            
            updateBulkActionsVisibility();
        }
        
        function updateBulkActionsVisibility() {
            const bulkActions = document.getElementById('bulk-actions');
            const selectedCountSpan = document.getElementById('selected-count');
            
            if (selectedTasks.size > 0) {
                bulkActions.classList.remove('hidden');
                selectedCountSpan.textContent = selectedTasks.size;
            } else {
                bulkActions.classList.add('hidden');
            }
        }
        
        function bulkUpdateProgress(taskIds, progress) {
            const promises = taskIds.map(taskId => {
                return fetch(`/tasks/${taskId}/progress`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: `progress=${progress}`
                });
            });
            
            Promise.all(promises)
                .then(responses => {
                    const successCount = responses.filter(r => r.ok).length;
                    showToast('Success', `Updated ${successCount} tasks successfully!`, 'success');
                    
                    // Clear selections
                    clearTaskSelections();
                })
                .catch(error => {
                    console.error('âŒ Bulk update error:', error);
                    showToast('Error', 'Some updates failed. Please try again.', 'error');
                });
        }
        
        function clearTaskSelections() {
            selectedTasks.clear();
            document.querySelectorAll('.task-checkbox').forEach(cb => cb.checked = false);
            updateBulkActionsVisibility();
        }
        
        // ================================================================
        // UTILITY FUNCTIONS
        // ================================================================
        
        function initializeTaskList() {
            // Extract current project ID from task data
            const firstTask = document.querySelector('[data-project-id]');
            if (firstTask) {
                currentProjectId = firstTask.dataset.projectId;
            }
            
            // Initialize filter counts
            updateFilterCounts();
            
            // Initialize statistics
            updateStatistics();
        }
        
        function updateConnectionStatus(status, message) {
            const indicator = document.getElementById('realtime-status');
            const text = document.getElementById('connection-text');
            
            if (indicator) {
                indicator.className = 'real-time-indicator ' + (status === 'connected' ? '' : 
                                   status === 'connecting' ? 'connecting' : 'disconnected');
            }
            
            if (text) {
                text.textContent = message;
            }
        }
        
        function showConnectionBanner(message, type, duration = 0) {
            const banner = document.getElementById('connection-banner');
            const bannerText = document.getElementById('connection-banner-text');
            
            if (banner && bannerText) {
                banner.className = `connection-status-banner alert alert-${type} mb-0 show`;
                bannerText.textContent = message;
                
                if (duration > 0) {
                    setTimeout(() => {
                        banner.classList.remove('show');
                    }, duration);
                }
            }
        }
        
        function updateStatistics() {
            const allTasks = document.querySelectorAll('.task-item');
            const completedTasks = document.querySelectorAll('.task-item.completed');
            const pendingTasks = allTasks.length - completedTasks.length;
            
            // Update real-time stats
            document.getElementById('stats-total').textContent = allTasks.length;
            document.getElementById('stats-pending').textContent = pendingTasks;
            document.getElementById('stats-completed').textContent = completedTasks.length;
            
            // Update visible task count
            const visibleTasks = document.querySelectorAll('.task-item:not([style*="display: none"])');
            document.getElementById('visible-task-count').textContent = visibleTasks.length;
        }
        
        function updateFilterCounts() {
            const allTasks = document.querySelectorAll('.task-item');
            const completedTasks = document.querySelectorAll('.task-item[data-status="completed"]');
            const pendingTasks = document.querySelectorAll('.task-item[data-status="pending"]');
            
            // Count overdue and due soon tasks
            let overdueCount = 0;
            let dueSoonCount = 0;
            
            allTasks.forEach(task => {
                const dueDateElement = task.querySelector('.due-date');
                if (dueDateElement && task.dataset.status === 'pending') {
                    // Simple logic - in real implementation, calculate actual dates
                    if (Math.random() > 0.8) overdueCount++;
                    else if (Math.random() > 0.7) dueSoonCount++;
                }
            });
            
            // Update filter badges
            document.getElementById('count-all').textContent = allTasks.length;
            document.getElementById('count-pending').textContent = pendingTasks.length;
            document.getElementById('count-completed').textContent = completedTasks.length;
            document.getElementById('count-overdue').textContent = overdueCount;
            document.getElementById('count-due-soon').textContent = dueSoonCount;
        }
        
        function updateActiveUsersCount() {
            // Simulate active users count
            const count = Math.floor(Math.random() * 8) + 1;
            document.getElementById('stats-active-users').textContent = count;
        }
        
        function setupEnhancedFiltering() {
            // Status filter badges
            document.querySelectorAll('.filter-badge').forEach(badge => {
                badge.addEventListener('click', function() {
                    const filter = this.dataset.filter;
                    
                    // Update active state
                    document.querySelectorAll('.filter-badge').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Apply filter
                    applyStatusFilter(filter);
                });
            });
            
            // Dropdown filters
            ['projectFilter', 'subsystemFilter', 'priorityFilter'].forEach(filterId => {
                const element = document.getElementById(filterId);
                if (element) {
                    element.addEventListener('change', applyAdvancedFilters);
                }
            });
            
            // Sort dropdown
            const sortBy = document.getElementById('sortBy');
            if (sortBy) {
                sortBy.addEventListener('change', function() {
                    applySorting(this.value);
                });
            }
            
            // Refresh button
            const refreshBtn = document.getElementById('refresh-tasks');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    refreshTaskList();
                });
            }
        }
        
        function setupRealTimeSearch() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', debounce(function() {
                    applyAdvancedFilters();
                }, 300));
            }
        }
        
        function applyStatusFilter(status) {
            const tasks = document.querySelectorAll('.task-item');
            
            tasks.forEach(task => {
                const taskStatus = task.dataset.status;
                let show = false;
                
                switch (status) {
                    case 'all':
                        show = true;
                        break;
                    case 'pending':
                        show = taskStatus === 'pending';
                        break;
                    case 'completed':
                        show = taskStatus === 'completed';
                        break;
                    case 'overdue':
                        // Simplified logic - in real implementation, check actual dates
                        show = taskStatus === 'pending' && Math.random() > 0.8;
                        break;
                    case 'due-soon':
                        // Simplified logic - in real implementation, check actual dates
                        show = taskStatus === 'pending' && Math.random() > 0.7;
                        break;
                    default:
                        show = true;
                }
                
                task.style.display = show ? 'block' : 'none';
            });
            
            updateStatistics();
        }
        
        function applyAdvancedFilters() {
            const projectFilter = document.getElementById('projectFilter')?.value;
            const subsystemFilter = document.getElementById('subsystemFilter')?.value;
            const priorityFilter = document.getElementById('priorityFilter')?.value;
            const searchQuery = document.getElementById('searchInput')?.value.toLowerCase();
            
            const tasks = document.querySelectorAll('.task-item');
            
            tasks.forEach(task => {
                let show = true;
                
                // Project filter
                if (projectFilter && task.dataset.projectId !== projectFilter) {
                    show = false;
                }
                
                // Priority filter
                if (priorityFilter && task.dataset.priority !== priorityFilter) {
                    show = false;
                }
                
                // Search filter
                if (searchQuery) {
                    const taskText = task.textContent.toLowerCase();
                    if (!taskText.includes(searchQuery)) {
                        show = false;
                    }
                }
                
                task.style.display = show ? 'block' : 'none';
            });
            
            updateStatistics();
        }
        
        function applySorting(sortBy) {
            const taskList = document.getElementById('taskList');
            const tasks = Array.from(taskList.querySelectorAll('.task-item'));
            
            tasks.sort((a, b) => {
                switch (sortBy) {
                    case 'priority':
                        const priorityOrder = { 'CRITICAL': 4, 'HIGH': 3, 'MEDIUM': 2, 'LOW': 1 };
                        return priorityOrder[b.dataset.priority] - priorityOrder[a.dataset.priority];
                    
                    case 'progress':
                        return parseInt(b.dataset.progress) - parseInt(a.dataset.progress);
                    
                    case 'title':
                        return a.dataset.title.localeCompare(b.dataset.title);
                    
                    case 'recent':
                        // Sort by last update time (most recent first)
                        return 1; // Simplified - in real implementation, use actual timestamps
                    
                    default:
                        return 0;
                }
            });
            
            // Re-append sorted tasks
            tasks.forEach(task => taskList.appendChild(task));
        }
        
        function refreshTaskList() {
            const refreshBtn = document.getElementById('refresh-tasks');
            const icon = refreshBtn.querySelector('i');
            
            icon.classList.add('fa-spin');
            
            // Simulate refresh
            setTimeout(() => {
                icon.classList.remove('fa-spin');
                showToast('Success', 'Task list refreshed!', 'success');
                updateStatistics();
            }, 1000);
        }
        
        function processQueuedUpdates() {
            // Process any updates that were queued while disconnected
            if (taskUpdateQueue.size > 0) {
                console.log(`ðŸ“¤ Processing ${taskUpdateQueue.size} queued updates...`);
                
                taskUpdateQueue.forEach((update, taskId) => {
                    handleRealTimeTaskUpdate(update);
                });
                
                taskUpdateQueue.clear();
                showToast('Info', 'Synchronized queued changes', 'info');
            }
        }
        
        function sendPresenceUpdate(status) {
            if (stompClient && isConnected) {
                const presence = {
                    status: status,
                    timestamp: new Date().toISOString(),
                    location: 'task_list'
                };
                
                stompClient.publish({
                    destination: '/app/presence/update',
                    body: JSON.stringify(presence)
                });
            }
        }
        
        function getCurrentUsername() {
            // Get current username from the page context
            const userElement = document.querySelector('[data-current-user]');
            return userElement ? userElement.dataset.currentUser : 'Unknown';
        }
        
        function getProgressBarClass(progress) {
            if (progress >= 100) return 'bg-success';
            if (progress >= 75) return 'bg-info';
            if (progress >= 50) return 'bg-warning';
            return 'bg-danger';
        }
        
        function getTaskUpdateIcon(changeType) {
            switch (changeType) {
                case 'COMPLETED': return 'fas fa-check-circle';
                case 'PROGRESS_CHANGED': return 'fas fa-chart-line';
                case 'CREATED': return 'fas fa-plus-circle';
                case 'UPDATED': return 'fas fa-edit';
                default: return 'fas fa-tasks';
            }
        }
        
        function getSeverityClass(severity) {
            switch (severity) {
                case 'SUCCESS': return 'text-success';
                case 'WARNING': return 'text-warning';
                case 'ERROR': return 'text-danger';
                default: return 'text-info';
            }
        }
        
        function getTimeAgo(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diffInSeconds = Math.floor((now - time) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
            return `${Math.floor(diffInSeconds / 86400)}d ago`;
        }
        
        function isElementInViewport(el) {
            const rect = el.getBoundingClientRect();
            return (
                rect.top >= 0 &&
                rect.left >= 0 &&
                rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
                rect.right <= (window.innerWidth || document.documentElement.clientWidth)
            );
        }
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        function showRealTimeNotification(notification) {
            showToast(notification.title, notification.message, notification.type.toLowerCase());
        }
        
        function showToast(title, message, type = 'info') {
            // Use the global showToast function from base.html
            if (window.showToast) {
                window.showToast(title, message, type);
            } else {
                console.log(`${title}: ${message}`);
            }
        }
        
        // ================================================================
        // PLACEHOLDER FUNCTIONS FOR PHASE 2E-B ENHANCEMENTS
        // ================================================================
        
        function handleNewTaskCreation(taskUpdate) {
            // TODO: Implement dynamic task creation in list
            console.log('ðŸ“ New task created:', taskUpdate);
            updateStatistics();
            updateFilterCounts();
        }
        
        function markTaskAsCompleted(taskId) {
            const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
            if (taskElement) {
                taskElement.classList.add('completed');
                taskElement.dataset.status = 'completed';
                
                // Update complete button
                const completeBtn = taskElement.querySelector('.complete-btn');
                if (completeBtn) {
                    completeBtn.innerHTML = '<i class="fas fa-undo" style="color: #ffc107"></i>';
                    completeBtn.dataset.completed = 'true';
                    completeBtn.title = 'Mark incomplete';
                }
            }
        }
        
        function updateTaskMetadata(taskId, taskUpdate) {
            const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
            if (taskElement && taskUpdate.taskTitle) {
                const titleElement = taskElement.querySelector('.task-title a');
                if (titleElement) {
                    titleElement.textContent = taskUpdate.taskTitle;
                }
                taskElement.dataset.title = taskUpdate.taskTitle;
            }
        }
        
        function showBulkAssignModal(taskIds) {
            // TODO: Implement bulk assignment modal
            console.log('ðŸ‘¥ Bulk assign modal for tasks:', taskIds);
            showToast('Info', 'Bulk assignment modal - coming soon!', 'info');
        }
        
        function showBulkPriorityModal(taskIds) {
            // TODO: Implement bulk priority modal
            console.log('âš¡ Bulk priority modal for tasks:', taskIds);
            showToast('Info', 'Bulk priority modal - coming soon!', 'info');
        }
        
        function confirmBulkDelete(taskIds) {
            // TODO: Implement bulk delete confirmation
            console.log('ðŸ—‘ï¸ Bulk delete confirmation for tasks:', taskIds);
            showToast('Info', 'Bulk delete confirmation - coming soon!', 'info');
        }
        
        // ================================================================
        // CLEANUP AND LIFECYCLE
        // ================================================================
        
        // Send presence update when leaving
        window.addEventListener('beforeunload', function() {
            sendPresenceUpdate('OFFLINE');
            
            if (stompClient && isConnected) {
                stompClient.deactivate();
            }
        });
        
        // Handle visibility changes
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                sendPresenceUpdate('AWAY');
            } else {
                sendPresenceUpdate('ONLINE');
            }
        });
        
        // ================================================================
        // INITIALIZATION COMPLETE
        // ================================================================
        
        console.log('ðŸŽ¯ Phase 2E-B Task List: Real-time WebSocket integration complete!');
        console.log('âœ¨ Features active:');
        console.log('   â€¢ Live task progress updates');
        console.log('   â€¢ Real-time activity feed');
        console.log('   â€¢ Enhanced bulk operations');
        console.log('   â€¢ Advanced filtering and search');
        console.log('   â€¢ Mobile-optimized interface');
        console.log('   â€¢ Offline resilience with sync');
    </script>
</div>
</body>
</html>